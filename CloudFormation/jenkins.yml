Description:
  Daniel Salazar | June 2020
  This will create an EC2 instance and install Jenkins. The security group's CIDR IP should be changed to the IP of
  the dev computer. This is used as an automation server to automate the tasks associated with CI/CD. 
  
Parameters:
  EnvironmentName:
    Description: An environment name that will be prefixed to resource names
    Type: String


Resources:
  JenkinsHost:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-003634241a8fcdec0 # Ubuntu
      # Ideally you want to only put the key during the time that you execute
      # this script. Remove it immediately after
      # Remember: If you push this, the key name will be public
      KeyName: jenkins-key
      SubnetId: 
        Fn::ImportValue:
          !Sub "${EnvironmentName}-PUB1-SN"
      SecurityGroupIds:
        - !Ref JenkinsSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Install Docker
          sudo apt-get update && curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker ubuntu
          sudo docker pull dsalazar10/udagram:jenkins
          sudo docker run -p 8080:8080 dsalazar10/udagram:jenkins

  JenkinsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties: 
      # A description for the security group
      # String
      GroupDescription: Allow ssh to/from our Jenkins host
      SecurityGroupEgress: 
      - IpProtocol: tcp
        FromPort: 0
        ToPort: 65535
        CidrIp: 0.0.0.0/0
      # The name of the security group
      # GroupName: String
      # The inbound rules associated with the security group
      SecurityGroupIngress: 
      - IpProtocol: tcp
        FromPort: 8080
        ToPort: 8080
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 0.0.0.0/0 # Change this to my IP Address
      # Any tags assigned to the security group
      #Tags: 
      #  - Tag
      # The ID of the VPC for the security group
      # String
      VpcId: 
        Fn::ImportValue:
          !Sub "${EnvironmentName}-VPCID"

Outputs:
  BastionIP:
    Description: The Public IP Address of the Jenkins host
    Value:  !GetAtt [JenkinsHost, PublicIp]
    Export:
      Name: !Sub ${EnvironmentName}-J-IP